<?php
namespace Admin\Model;
use Think\Model;

/**
 * 联盟商家详情表模型
 * @author yuanyulin  <QQ:1358140190>
 */

class AllianceMerchantDetailModel extends Model{    
    
//    protected $insertFields = array('position_x', 'position_y', 'map_height', 'map_width', 'map_color', 'name', 'photo_path', 'address', 'add_time', 'phone', 'recommend', 'others', 'member_id', 'map_id');
//    protected $updateFields = array('id', 'position_x', 'position_y', 'map_height', 'map_width', 'map_color', 'name', 'photo_path', 'address', 'add_time', 'phone', 'recommend', 'others', 'member_id', 'map_id');
//
//    protected $_validate = array(       
//        array('position_x', 'require', 'x坐标必须填写',   self::MUST_VALIDATE, 'regex', 3),
//        array('position_x', 'number',  'x坐标必须是数字', self::MUST_VALIDATE, 'regex', 3),
//        
//        array('position_y', 'require', 'y坐标必须填写',   self::MUST_VALIDATE, 'regex', 3),
//        array('position_y', 'number',  'y坐标必须是数字', self::MUST_VALIDATE, 'regex', 3),
//        
//        array('map_height', 'require', '区域高度必须填写',   self::MUST_VALIDATE, 'regex', 3),
//        array('map_height', 'number',  '区域高度必须是数字', self::MUST_VALIDATE, 'regex', 3),
//        
//        array('map_width', 'require', '区域宽度必须填写',   self::MUST_VALIDATE, 'regex', 3),
//        array('map_width', 'number',  '区域宽度必须是数字', self::MUST_VALIDATE, 'regex', 3),
//        
//        array('map_color', 'require', '区域颜色必须填写', self::MUST_VALIDATE, 'regex', 3),
//        
//        array('name', 'require', '商家名称必须填写',            self::MUST_VALIDATE, 'regex',  3),
//        array('name', '1,24',    '商家名称长度在1-24个字符之间', self::MUST_VALIDATE, 'length', 3),
//        
//        array('photo_path', 'require', '图片路径必须填写', self::MUST_VALIDATE, 'regex', 3),
//        
//        array('address', 'require', '商家地址必须填写',             self::MUST_VALIDATE, 'regex',  3),
//        array('address', '1,56',    '商家地址长度在1-56个字符之间', self::MUST_VALIDATE, 'length', 3 ),
//        
//        array('phone', 'require', '商家电话必须填写',   self::MUST_VALIDATE, 'regex', 3),
//        array('phone', 'number',  '商家电话必须是数字', self::MUST_VALIDATE, 'regex', 3),
//        array('map_id', 'require', '所属地图必须填写', self::MUST_VALIDATE, 'regex', 3),
//        
//        array('recommend', '0,90', '推荐理由不能超过90', self::VALUE_VALIDATE, 'length', 3),
//        
//        array('others', '0,56', '其他信息不能超过56个字符', self::VALUE_VALIDATE, 'length', 3),
//    );


    protected $insertFields = array('name', 'position_x', 'position_y', 'add_time', 'address', 'phone', 'photo_path', 'recommend', 'others');
    protected $updateFields = array('id', 'name', 'position_x', 'position_y', 'add_time', 'address', 'phone', 'photo_path', 'recommend', 'others');
    protected $selectFields = array('id', 'photo_path', 'name', 'address', 'recommend', 'phone', 'add_time', 'others');

    protected $_validate = array(
        array('name', '1,24', '商家名称长度在1-24个字符之间', self::MUST_VALIDATE, 'length', 3),
        array('address', '1,56', '商家地址长度在1-56个字符之间', self::MUST_VALIDATE, 'length', 3 ),
        array('recommend', '0,90', '推荐理由不能超过90', self::MUST_VALIDATE, 'length', 3),
        array('phone', 'number', '电话号码必须是数字', self::MUST_VALIDATE),
        array('phone', '5,30', '电话号码长度在5-30个字符之间', self::MUST_VALIDATE, 'length', 3),
        array('others', '0,56', '其他信息不能超过56个字符', self::MUST_VALIDATE, 'length', 3),
    );

    // 获得联盟商家详情
    public function search(){
        $name = I('post.name', '','trim');
        if($name) {
            $where['name'] = array('like',"%$name%");
        }
        $where['member_id'] = array('eq', UID);
        $data = $this->getAllianceMerchantDetailByPage($where, $field='detail.id, name, address, phone, add_time, member.user_name ', $order='id desc');

        return $data;
    }

    protected function _before_insert(&$data,$option) {
        $data['member_id'] = UID;
        $data['add_time'] = time();
    }

    protected function _before_update(&$data,$option) {
        $data['member_id'] = UID;
        $data['add_time'] = time();
    }
    /**
     * 获取分页方法
     * @param array $where 传入where条件
     * @param string $order 排序方式
     * @return array 搜索数据和分页数据
     */
    public function getAllianceMerchantDetailByPage($where, $field=null, $order='id'){
        if ($field == null) {
            $field = $this->selectFields;
        }
        $count = $this->where($where)->count();
        $page = get_page($count);

        $data = $this->alias('detail')
            ->join('__MEMBER__ member ON detail.member_id = member.id', 'left')
            ->field($field)
            ->where($where)
            ->limit($page['limit'])
            ->order($order)
            ->select();
       // echo $this->_sql();
        return array(
                'data' => $data,
                'page' => $page['page']
            );
    }


}